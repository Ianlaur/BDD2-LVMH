<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVMH Client Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        /* SVG Icons */
        .icon { width: 16px; height: 16px; fill: currentColor; flex-shrink: 0; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 32px; height: 32px; opacity: 0.4; }

        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #131316;
            --bg-tertiary: #1a1a1f;
            --bg-card: #1e1e24;
            --border-color: #2a2a32;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a8;
            --text-muted: #6b6b75;
            --accent-gold: #c9a962;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo { display: flex; align-items: center; gap: 12px; }

        .logo-icon {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #a08040 100%);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
        }

        .logo-text { font-size: 18px; font-weight: 600; letter-spacing: -0.5px; }
        .logo-text span { color: var(--text-muted); font-weight: 400; }

        .header-stats { display: flex; gap: 32px; }
        .header-stat { text-align: center; }
        .header-stat-value { font-size: 20px; font-weight: 600; }
        .header-stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        .nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            display: flex;
            gap: 4px;
        }

        .nav-item {
            padding: 16px 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-item:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .nav-item.active { color: var(--accent-gold); border-bottom-color: var(--accent-gold); }

        .main { display: none; padding: 24px 32px; gap: 24px; }
        .main.active { display: grid; }

        #overview-content { grid-template-columns: 1fr 1fr; grid-template-rows: auto 1fr; }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .card-title-icon {
            width: 20px; height: 20px;
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }

        .card-body { padding: 20px; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            grid-column: 1 / -1;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .metric-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .metric-value { font-size: 32px; font-weight: 700; line-height: 1; margin-bottom: 8px; }
        .metric-change { font-size: 12px; display: flex; align-items: center; gap: 4px; }
        .metric-change.positive { color: var(--accent-green); }

        .segment-list { display: flex; flex-direction: column; gap: 12px; }

        .segment-item {
            display: flex; align-items: center; gap: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .segment-item:hover { background: var(--border-color); }
        .segment-color { width: 4px; height: 40px; border-radius: 2px; }
        .segment-info { flex: 1; }
        .segment-name { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        .segment-profile { font-size: 12px; color: var(--text-muted); }
        .segment-count { font-size: 20px; font-weight: 600; color: var(--text-secondary); }

        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            text-align: left; padding: 12px 16px;
            font-size: 11px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table td { padding: 16px; font-size: 13px; border-bottom: 1px solid var(--border-color); }
        .data-table tr { cursor: pointer; }
        .data-table tr:hover { background: var(--bg-tertiary); }
        .client-id { font-family: 'SF Mono', Monaco, monospace; font-size: 12px; color: var(--accent-blue); }
        .profile-badge { display: inline-block; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 4px; font-size: 11px; color: var(--text-secondary); }

        .filters {
            display: flex; gap: 12px; padding: 16px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .search-input, .filter-select {
            padding: 10px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .search-input { flex: 1; max-width: 300px; }
        .search-input::placeholder { color: var(--text-muted); }
        .search-input:focus, .filter-select:focus { outline: none; border-color: var(--accent-gold); }
        .filter-select { cursor: pointer; }

        #clients-content { grid-template-columns: 1fr; }
        #visualization-content { grid-template-columns: 1fr; }
        #actions-content { grid-template-columns: 1fr; }

        #viz-3d-container { grid-column: 1 / -1; height: calc(100vh - 200px); }
        #plotly-3d { width: 100%; height: 100%; }

        .viz-controls { display: flex; gap: 12px; }

        .viz-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .viz-btn:hover { background: var(--border-color); color: var(--text-primary); }
        .viz-btn.active { background: var(--accent-gold); border-color: var(--accent-gold); color: var(--bg-primary); }

        .action-card {
            display: flex; gap: 20px; padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .action-icon {
            width: 48px; height: 48px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .action-icon.email { background: rgba(59, 130, 246, 0.15); }
        .action-icon.phone { background: rgba(16, 185, 129, 0.15); }
        .action-icon.crm { background: rgba(139, 92, 246, 0.15); }
        .action-icon.event { background: rgba(245, 158, 11, 0.15); }

        .action-content { flex: 1; }
        .action-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .action-description { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }
        .action-meta { display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); }

        .action-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 6px;
            font-size: 12px; font-weight: 500;
        }
        .action-badge.high { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .action-badge.medium { background: rgba(245, 158, 11, 0.15); color: var(--accent-orange); }
        .action-badge.low { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        .loading { display: flex; align-items: center; justify-content: center; height: 200px; color: var(--text-muted); }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Panel */
        .panel-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }
        .panel-overlay.open { opacity: 1; visibility: visible; }

        .detail-panel {
            position: fixed; top: 0; right: 0;
            width: 520px; max-width: 90vw; height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 201;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .detail-panel.open { transform: translateX(0); }

        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .panel-title { font-size: 16px; font-weight: 600; }

        .panel-close {
            width: 32px; height: 32px; border: none;
            background: var(--bg-tertiary);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .panel-close:hover { background: var(--border-color); color: var(--text-primary); }

        .panel-body { flex: 1; overflow-y: auto; padding: 24px; }
        .panel-section { margin-bottom: 24px; }

        .panel-section-title {
            font-size: 11px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }

        .panel-client-header {
            display: flex; align-items: center; gap: 16px;
            margin-bottom: 24px; padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-client-avatar {
            width: 56px; height: 56px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #a08040 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 700;
            flex-shrink: 0;
        }

        .panel-client-info h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .panel-client-info p { font-size: 13px; color: var(--text-secondary); }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .info-item { background: var(--bg-tertiary); border-radius: 8px; padding: 12px; }
        .info-item-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .info-item-value { font-size: 14px; font-weight: 500; }

        .extracted-text {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            font-style: italic;
            white-space: pre-wrap;
        }

        .tag-list { display: flex; flex-direction: column; gap: 8px; }

        .tag-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex; align-items: flex-start; gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag-item:hover { background: var(--border-color); }
        .tag-color { width: 4px; min-height: 20px; border-radius: 2px; flex-shrink: 0; }
        .tag-content { flex: 1; min-width: 0; }
        .tag-name { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
        .tag-bucket { font-size: 10px; padding: 2px 6px; background: var(--bg-primary); border-radius: 4px; color: var(--text-muted); margin-left: 8px; }

        .mini-viz { height: 200px; background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">LV</div>
            <div class="logo-text">Client Intelligence <span>Dashboard</span></div>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="stat-clients">-</div>
                <div class="header-stat-label">Clients</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="stat-segments">-</div>
                <div class="header-stat-label">Segments</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="stat-concepts">-</div>
                <div class="header-stat-label">Concepts</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="stat-actions">-</div>
                <div class="header-stat-label">Actions</div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-item active" data-tab="overview">Overview</div>
        <div class="nav-item" data-tab="clients">Clients</div>
        <div class="nav-item" data-tab="visualization">3D Space</div>
        <div class="nav-item" data-tab="actions">Actions</div>
    </nav>

    <!-- Overview Tab -->
    <main id="overview-content" class="main active">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Clients</div>
                <div class="metric-value" id="metric-clients">-</div>
                <div class="metric-change positive">↑ 100% coverage</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Profile Types</div>
                <div class="metric-value" id="metric-segments">-</div>
                <div class="metric-change">Distinct segments</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Concepts Detected</div>
                <div class="metric-value" id="metric-concepts">21</div>
                <div class="metric-change">Multilingual</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Actions Generated</div>
                <div class="metric-value" id="metric-actions">-</div>
                <div class="metric-change positive">3 per client avg</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon" style="background: var(--accent-purple);">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    </span>
                    Client Segments
                </div>
            </div>
            <div class="card-body">
                <div class="segment-list" id="segment-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon" style="background: var(--accent-blue);">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                    </span>
                    Top Actions
                </div>
            </div>
            <div class="card-body">
                <div id="top-actions">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Clients Tab -->
    <main id="clients-content" class="main">
        <div class="card">
            <div class="filters">
                <input type="text" class="search-input" id="client-search" placeholder="Search clients...">
                <select class="filter-select" id="segment-filter">
                    <option value="">All Segments</option>
                </select>
                <select class="filter-select" id="profile-filter">
                    <option value="">All Profiles</option>
                </select>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Client ID</th>
                            <th>Segment</th>
                            <th>Profile Type</th>
                            <th>Top Concepts</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 3D Visualization Tab -->
    <main id="visualization-content" class="main">
        <div class="card" id="viz-3d-container">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon" style="background: var(--accent-green);">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    </span>
                    3D Client Embedding Space
                </div>
                <div class="viz-controls">
                    <button class="viz-btn active" onclick="setColorBy('segment')">Color by Segment</button>
                    <button class="viz-btn" onclick="setColorBy('profile')">Color by Profile</button>
                </div>
            </div>
            <div id="plotly-3d"></div>
        </div>
    </main>

    <!-- Actions Tab -->
    <main id="actions-content" class="main">
        <div class="card">
            <div class="filters">
                <input type="text" class="search-input" id="action-search" placeholder="Search actions...">
                <select class="filter-select" id="priority-filter">
                    <option value="">All Priorities</option>
                    <option value="High">High Priority</option>
                    <option value="Medium">Medium Priority</option>
                    <option value="Low">Low Priority</option>
                </select>
                <select class="filter-select" id="channel-filter">
                    <option value="">All Channels</option>
                </select>
            </div>
            <div class="card-body" id="actions-list">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </main>

    <!-- Client Detail Panel -->
    <div class="panel-overlay" id="panel-overlay" onclick="closeDetailPanel()"></div>
    <aside class="detail-panel" id="detail-panel">
        <div class="panel-header">
            <div class="panel-title">Client Details</div>
            <button class="panel-close" onclick="closeDetailPanel()">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="panel-body" id="panel-body"></div>
    </aside>

    <script>
        // Data
        let clientsData = [];
        let actionsData = [];
        let segmentsData = {};
        let transcriptData = {};
        let lexiconData = {};

        const segmentColors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4', '#84cc16'];

        // Tab switching
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.main').forEach(m => m.classList.remove('active'));
                item.classList.add('active');
                document.getElementById(item.dataset.tab + '-content').classList.add('active');
                if (item.dataset.tab === 'visualization') init3DVisualization();
            });
        });

        // Load data
        async function loadData() {
            try {
                const res = await fetch('../data/outputs/client_profiles.csv');
                if (res.ok) clientsData = parseCSV(await res.text());
            } catch (e) { console.log('Profiles not found'); }

            try {
                const res = await fetch('../data/outputs/recommended_actions.csv');
                if (res.ok) actionsData = parseCSV(await res.text());
            } catch (e) { console.log('Actions not found'); }

            try {
                const res = await fetch('../taxonomy/lexicon_v1.json');
                if (res.ok) lexiconData = await res.json();
            } catch (e) { console.log('Lexicon not found'); }

            // Load transcripts
            const inputFiles = ['../data/LVMH_Realistic_Merged_CA001-100.csv', '../data/input/LVMH_Sales_Database.csv'];
            for (const file of inputFiles) {
                try {
                    const res = await fetch(file);
                    if (res.ok) {
                        const data = parseCSV(await res.text());
                        data.forEach(t => {
                            const id = (t.ID || t.client_id || '').replace('CA_', 'SA_');
                            if (id) transcriptData[id] = {
                                text: t.Transcription || t.transcription || t.text || '',
                                date: t.Date || '', duration: t.Duration || '', language: t.Language || ''
                            };
                        });
                        break;
                    }
                } catch (e) {}
            }

            if (clientsData.length === 0) loadSampleData();
            else { updateStats(); renderSegments(); renderClientsTable(); renderTopActions(); renderActionsList(); }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (!lines.length) return [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return lines.slice(1).map(line => {
                const values = []; let current = ''; let inQuotes = false;
                for (const char of line) {
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
                    else current += char;
                }
                values.push(current.trim());
                const obj = {};
                headers.forEach((h, i) => obj[h] = (values[i] || '').replace(/"/g, ''));
                return obj;
            });
        }

        function loadSampleData() {
            const profiles = ['Art Collector', 'Philanthropist', 'Watch Enthusiast', 'Fashion Forward', 'Luxury Traveler', 'Wine Connoisseur', 'Tech Executive', 'Lifestyle Seeker'];
            clientsData = Array.from({length: 100}, (_, i) => ({
                client_id: `SA_${String(i+1).padStart(3, '0')}`,
                cluster_id: String(i % 8),
                profile_type: profiles[i % 8],
                top_concepts: 'art collector|philanthropy|haute couture',
                confidence: (0.6 + Math.random() * 0.4).toFixed(4)
            }));
            actionsData = Array.from({length: 300}, (_, i) => ({
                client_id: `SA_${String((i % 100)+1).padStart(3, '0')}`,
                title: ['VIP Event', 'Private Preview', 'Follow-up Call', 'Exclusive Offer', 'Anniversary Gift'][i % 5],
                channel: ['Email', 'CRM', 'Phone', 'Event'][i % 4],
                priority: ['High', 'Medium', 'Low'][i % 3],
                rationale: 'Based on client profile'
            }));
            updateStats(); renderSegments(); renderClientsTable(); renderTopActions(); renderActionsList();
        }

        function updateStats() {
            const segments = new Set(clientsData.map(c => c.cluster_id || c.segment));
            segmentsData = {};
            clientsData.forEach(c => {
                const id = c.cluster_id || c.segment || '0';
                if (!segmentsData[id]) segmentsData[id] = { count: 0, profile: c.profile_type || 'Unknown' };
                segmentsData[id].count++;
            });

            document.getElementById('stat-clients').textContent = clientsData.length;
            document.getElementById('stat-segments').textContent = segments.size;
            document.getElementById('stat-concepts').textContent = '21';
            document.getElementById('stat-actions').textContent = actionsData.length || '-';
            document.getElementById('metric-clients').textContent = clientsData.length;
            document.getElementById('metric-segments').textContent = segments.size;
            document.getElementById('metric-actions').textContent = actionsData.length.toLocaleString();

            const segFilter = document.getElementById('segment-filter');
            segFilter.innerHTML = '<option value="">All Segments</option>';
            Object.keys(segmentsData).forEach(s => {
                segFilter.innerHTML += `<option value="${s}">Segment ${s}</option>`;
            });

            const profiles = [...new Set(clientsData.map(c => c.profile_type || c.profile).filter(Boolean))];
            const profFilter = document.getElementById('profile-filter');
            profFilter.innerHTML = '<option value="">All Profiles</option>';
            profiles.forEach(p => profFilter.innerHTML += `<option value="${p}">${p}</option>`);
        }

        function renderSegments() {
            const container = document.getElementById('segment-list');
            container.innerHTML = Object.entries(segmentsData)
                .sort((a, b) => b[1].count - a[1].count)
                .map(([id, data], idx) => `
                    <div class="segment-item" onclick="filterBySegment('${id}')">
                        <div class="segment-color" style="background: ${segmentColors[idx % 8]}"></div>
                        <div class="segment-info">
                            <div class="segment-name">Segment ${id}</div>
                            <div class="segment-profile">${data.profile}</div>
                        </div>
                        <div class="segment-count">${data.count}</div>
                    </div>
                `).join('');
        }

        function filterBySegment(id) {
            document.querySelector('[data-tab="clients"]').click();
            document.getElementById('segment-filter').value = id;
            renderClientsTable();
        }

        function renderClientsTable() {
            const search = document.getElementById('client-search').value.toLowerCase();
            const segment = document.getElementById('segment-filter').value;
            const profile = document.getElementById('profile-filter').value;

            const filtered = clientsData.filter(c => {
                if (search && !c.client_id.toLowerCase().includes(search) && !(c.profile_type || '').toLowerCase().includes(search)) return false;
                if (segment && (c.cluster_id || c.segment) !== segment) return false;
                if (profile && c.profile_type !== profile) return false;
                return true;
            });

            const tbody = document.getElementById('clients-table-body');
            tbody.innerHTML = filtered.slice(0, 100).map(c => {
                const segId = c.cluster_id || c.segment || '0';
                return `
                    <tr onclick="openDetailPanel('${c.client_id}')">
                        <td><span class="client-id">${c.client_id}</span></td>
                        <td><span style="display:inline-flex;align-items:center;gap:8px;"><span style="width:8px;height:8px;border-radius:50%;background:${segmentColors[parseInt(segId) % 8]}"></span>Segment ${segId}</span></td>
                        <td><span class="profile-badge">${c.profile_type || 'Unknown'}</span></td>
                        <td style="color:var(--text-muted);font-size:12px;">${(c.top_concepts || '').substring(0, 40)}...</td>
                        <td>${c.confidence ? (parseFloat(c.confidence) * 100).toFixed(0) + '%' : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('client-search').addEventListener('input', renderClientsTable);
        document.getElementById('segment-filter').addEventListener('change', renderClientsTable);
        document.getElementById('profile-filter').addEventListener('change', renderClientsTable);

        function renderTopActions() {
            const container = document.getElementById('top-actions');
            if (!actionsData.length) { container.innerHTML = '<div class="empty-state">No actions yet</div>'; return; }

            const counts = {};
            actionsData.forEach(a => { const t = a.title || 'Action'; counts[t] = (counts[t] || 0) + 1; });
            const top = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            container.innerHTML = top.map(([title, count]) => `
                <div class="action-card">
                    <div class="action-icon event">
                        <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">${title}</div>
                        <div class="action-description">${count} clients targeted</div>
                    </div>
                </div>
            `).join('');
        }

        function renderActionsList() {
            const container = document.getElementById('actions-list');
            const search = (document.getElementById('action-search')?.value || '').toLowerCase();
            const priority = document.getElementById('priority-filter')?.value || '';
            const channel = document.getElementById('channel-filter')?.value || '';

            const filtered = actionsData.filter(a => {
                if (search && !(a.title || '').toLowerCase().includes(search) && !a.client_id.toLowerCase().includes(search)) return false;
                if (priority && a.priority !== priority) return false;
                if (channel && a.channel !== channel) return false;
                return true;
            }).slice(0, 50);

            container.innerHTML = filtered.map(a => `
                <div class="action-card">
                    <div class="action-icon crm">
                        <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">${a.title || 'Action'}</div>
                        <div class="action-description">${a.rationale || 'Based on profile'}</div>
                        <div class="action-meta">
                            <span>Client: ${a.client_id}</span>
                            <span>Channel: ${a.channel || 'CRM'}</span>
                            <span class="action-badge ${(a.priority || 'medium').toLowerCase()}">${a.priority || 'Medium'}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Populate channel filter
            const channels = [...new Set(actionsData.map(a => a.channel).filter(Boolean))];
            const cf = document.getElementById('channel-filter');
            if (cf.options.length <= 1) channels.forEach(c => cf.innerHTML += `<option value="${c}">${c}</option>`);
        }

        document.getElementById('action-search')?.addEventListener('input', renderActionsList);
        document.getElementById('priority-filter')?.addEventListener('change', renderActionsList);
        document.getElementById('channel-filter')?.addEventListener('change', renderActionsList);

        // 3D Visualization
        let viz3DInitialized = false;

        function init3DVisualization() {
            if (viz3DInitialized) return;
            viz3DInitialized = true;

            const segments = [...new Set(clientsData.map(c => c.cluster_id || c.segment || '0'))];
            const traces = segments.map((seg, idx) => {
                const clients = clientsData.filter(c => (c.cluster_id || c.segment || '0') === seg);
                const angle = (idx / segments.length) * Math.PI * 2;
                const cx = Math.cos(angle) * 5, cy = Math.sin(angle) * 5, cz = (idx - segments.length/2) * 2;

                return {
                    x: clients.map(() => cx + (Math.random() - 0.5) * 3),
                    y: clients.map(() => cy + (Math.random() - 0.5) * 3),
                    z: clients.map(() => cz + (Math.random() - 0.5) * 3),
                    mode: 'markers',
                    type: 'scatter3d',
                    name: `Segment ${seg}`,
                    text: clients.map(c => `${c.client_id}<br>${c.profile_type || 'Unknown'}`),
                    hoverinfo: 'text',
                    marker: { size: 5, color: segmentColors[idx % 8], opacity: 0.8 }
                };
            });

            Plotly.newPlot('plotly-3d', traces, {
                paper_bgcolor: '#1e1e24', plot_bgcolor: '#1e1e24',
                font: { color: '#a0a0a8', family: 'Inter' },
                scene: {
                    xaxis: { gridcolor: '#2a2a32', title: '', showbackground: true, backgroundcolor: '#1a1a1f' },
                    yaxis: { gridcolor: '#2a2a32', title: '', showbackground: true, backgroundcolor: '#1a1a1f' },
                    zaxis: { gridcolor: '#2a2a32', title: '', showbackground: true, backgroundcolor: '#1a1a1f' },
                    bgcolor: '#1e1e24'
                },
                margin: { l: 0, r: 0, t: 20, b: 0 },
                legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(30,30,36,0.9)' }
            }, { responsive: true, displaylogo: false });
        }

        function setColorBy(mode) {
            document.querySelectorAll('.viz-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            viz3DInitialized = false;
            init3DVisualization();
        }

        // Detail Panel
        function openDetailPanel(clientId) {
            const client = clientsData.find(c => c.client_id === clientId);
            if (!client) return;

            document.getElementById('panel-overlay').classList.add('open');
            document.getElementById('detail-panel').classList.add('open');

            const segId = client.cluster_id || client.segment || '0';
            const transcript = transcriptData[clientId] || {};
            const text = transcript.text || 'No transcription available for this client.';
            const concepts = (client.top_concepts || '').split(/[,|]/).map(c => c.trim()).filter(Boolean);
            const clientActions = actionsData.filter(a => a.client_id === clientId);

            document.getElementById('panel-body').innerHTML = `
                <div class="panel-client-header">
                    <div class="panel-client-avatar">${clientId.slice(-3)}</div>
                    <div class="panel-client-info">
                        <h3>${clientId}</h3>
                        <p>${client.profile_type || 'Unknown Profile'}</p>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                        Overview
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-item-label">Segment</div>
                            <div class="info-item-value"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${segmentColors[parseInt(segId) % 8]};margin-right:8px;"></span>Segment ${segId}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Confidence</div>
                            <div class="info-item-value">${client.confidence ? (parseFloat(client.confidence) * 100).toFixed(0) + '%' : 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Tags Found</div>
                            <div class="info-item-value">${concepts.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Actions</div>
                            <div class="info-item-value">${clientActions.length}</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        Transcription
                        ${transcript.language ? `<span style="margin-left:auto;font-size:10px;padding:2px 6px;background:var(--bg-tertiary);border-radius:4px;">${transcript.language}</span>` : ''}
                    </div>
                    ${transcript.date || transcript.duration ? `<div style="display:flex;gap:16px;margin-bottom:12px;font-size:12px;color:var(--text-muted);">
                        ${transcript.date ? `<span>Date: ${transcript.date}</span>` : ''}
                        ${transcript.duration ? `<span>Duration: ${transcript.duration}</span>` : ''}
                    </div>` : ''}
                    <div class="extracted-text">"${text}"</div>
                </div>

                <div class="panel-section">
                    <div class="panel-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                        Detected Tags (${concepts.length})
                    </div>
                    <div class="tag-list">
                        ${concepts.map((c, i) => `
                            <div class="tag-item">
                                <div class="tag-color" style="background:${segmentColors[i % 8]}"></div>
                                <div class="tag-content">
                                    <div class="tag-name">${c.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}<span class="tag-bucket">detected</span></div>
                                </div>
                            </div>
                        `).join('') || '<div style="color:var(--text-muted)">No tags detected</div>'}
                    </div>
                </div>

                ${clientActions.length ? `
                <div class="panel-section">
                    <div class="panel-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        Recommended Actions (${clientActions.length})
                    </div>
                    ${clientActions.slice(0, 5).map(a => `
                        <div class="action-card" style="margin-bottom:8px;">
                            <div class="action-content" style="padding:0;">
                                <div class="action-title" style="font-size:13px;">${a.title || 'Action'}</div>
                                <div class="action-meta">${a.channel || 'CRM'} · <span class="action-badge ${(a.priority || 'medium').toLowerCase()}" style="padding:2px 8px;">${a.priority || 'Medium'}</span></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="panel-section">
                    <div class="panel-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"/></svg>
                        3D Position
                    </div>
                    <div class="mini-viz" id="mini-3d-${clientId}"></div>
                </div>
            `;

            // Render mini 3D
            setTimeout(() => renderMini3D(clientId, segId), 100);
        }

        function renderMini3D(clientId, segId) {
            const idx = parseInt(segId) % 8;
            const angle = (idx / 8) * Math.PI * 2;
            const cx = Math.cos(angle) * 5, cy = Math.sin(angle) * 5, cz = (idx - 4) * 2;

            Plotly.newPlot(`mini-3d-${clientId}`, [{
                x: [cx], y: [cy], z: [cz],
                mode: 'markers',
                type: 'scatter3d',
                marker: { size: 12, color: segmentColors[idx], symbol: 'diamond' },
                name: clientId
            }, {
                x: Array(20).fill().map(() => cx + (Math.random() - 0.5) * 3),
                y: Array(20).fill().map(() => cy + (Math.random() - 0.5) * 3),
                z: Array(20).fill().map(() => cz + (Math.random() - 0.5) * 3),
                mode: 'markers',
                type: 'scatter3d',
                marker: { size: 4, color: segmentColors[idx], opacity: 0.3 },
                name: 'Segment peers'
            }], {
                paper_bgcolor: '#1a1a1f', plot_bgcolor: '#1a1a1f',
                font: { color: '#6b6b75', size: 10 },
                scene: {
                    xaxis: { showgrid: false, zeroline: false, showticklabels: false, title: '' },
                    yaxis: { showgrid: false, zeroline: false, showticklabels: false, title: '' },
                    zaxis: { showgrid: false, zeroline: false, showticklabels: false, title: '' },
                    bgcolor: '#1a1a1f'
                },
                margin: { l: 0, r: 0, t: 0, b: 0 },
                showlegend: false
            }, { responsive: true, displayModeBar: false });
        }

        function closeDetailPanel() {
            document.getElementById('panel-overlay').classList.remove('open');
            document.getElementById('detail-panel').classList.remove('open');
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetailPanel(); });

        // Init
        loadData();
    </script>
</body>
</html>
